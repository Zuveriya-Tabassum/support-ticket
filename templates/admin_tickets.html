<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Tickets - Support Ticket System</title>
  <style>
    :root {
      --color-dark: #003135;
      --color-medium: #024950;
      --color-accent: #964734;
      --color-aqua: #0FAAAF;
      --color-light: #AFDDE5;
      --sidebar-width: 240px;
      --font-main: 'Poppins', 'Segoe UI', Arial, sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-main);
      background: var(--color-light);
      color: var(--color-dark);
      overflow: hidden;
      transition: background 0.35s, color 0.35s;
    }
    .page-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-dark);
      color: var(--color-light);
      height: 100vh; padding: 28px 17px; display: flex; flex-direction: column;
      box-shadow: 2px 0 18px #02495080; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;
      position: fixed; top: 0; left: 0;
    }
    .sidebar::-webkit-scrollbar { display: none; }
    .profile-image-container { width: 120px; height: 120px; margin: 0 auto 17px auto; display: flex; align-items: center; justify-content: center; }
    .profile-image { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 4px solid var(--color-aqua); background: #fff; box-shadow: 0 2px 14px #00313540; }
    .sidebar h2 { margin-bottom: 22px; font-size: 24px; color: var(--color-aqua); font-weight: 700; text-align: center; letter-spacing: 2px; }
    .sidebar-hr { border: none; height: 2px; background: linear-gradient(90deg, #0FAAAF33 30%, #00313544 100%); margin: 1.5px 0 20px 0; width: 82%; align-self: center; }
    .sidebar a { text-decoration: none; color: var(--color-light); margin: 10.5px 0; font-size: 17px; padding: 12px 10px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; transition: background 0.19s, color 0.17s;}
    .sidebar a.active, .sidebar a:hover { background: var(--color-aqua); color: #fff; font-weight: bold; box-shadow: 0 2px 12px #0faaf462; }
    .sidebar a#logoutBtn { background: var(--color-accent); color: #fff; margin-top: 2rem; font-weight: bold; }
    .content {
      flex: 1; padding: 40px 34px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;
      margin-left: calc(var(--sidebar-width) + 32px);
      min-height: 100vh;
      transition: background 0.35s, color 0.35s;
    }
    .content::-webkit-scrollbar { display: none; }
    .top-bar { display: flex; align-items: center; gap: 18px; margin-bottom: 18px; flex-wrap: wrap; }
    .filter-form { display: flex; align-items: center; gap: 16px; background: #fff; border-radius: 10px; box-shadow: 0 2px 14px #00313522; padding: 11px 19px; font-size: 16px; flex-wrap: wrap; }
    .filter-form select, .filter-form input[type="text"] { padding: 6px 10px; border-radius: 7px; border: 1.2px solid var(--color-aqua); background: var(--color-light); color: var(--color-dark); font-size: 15px;}
    .filter-form label { font-weight: 500; margin-right: 6px; color: var(--color-accent); }
    .filter-form .btn { padding: 8px 17px; font-size: 15px; background: var(--color-aqua); color: #fff; border: none; border-radius: 7px; font-weight: 600; box-shadow: 0 1px 7px #0faaf470; cursor: pointer; transition: background 0.13s; }
    .filter-form .btn:hover { background: var(--color-accent); }
    .toggle-mode { margin-left: auto; background: var(--color-aqua); color: #fff; border: none; border-radius: 9px; padding: 10px 23px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 12px #0faaf490; transition: background 0.13s;}
    .toggle-mode:hover { background: var(--color-accent); }
    .user-ticket-card {
      background: #fff; border-radius: 22px; padding: 22px 36px 30px 22px; margin-bottom: 36px;
      box-shadow: 0 4px 18px #00313516; position: relative; border-left: 8px solid var(--color-aqua); min-width: 300px;
      transition: background 0.35s, color 0.35s;
    }
    .user-ticket-header { display: flex; align-items: center; gap: 21px; margin-bottom: 1px; }
    .user-ticket-header .profile-pill { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--color-aqua); background: #eee; object-fit: cover;}
    .user-ticket-header .user-title { font-size: 1.32rem; font-weight: bold; color: var(--color-dark);}
    .user-ticket-header .user-email { color: var(--color-aqua); font-size: 1.04rem; font-weight: 500;}
    .ticket-dropdown-btn { margin-left: auto; background: var(--color-aqua); color: #fff; border: none; border-radius: 7px; padding: 8px 18px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 7px #0faaf470; transition: background 0.15s;}
    .ticket-dropdown-btn:hover { background: var(--color-accent);}
    .recent-ticket-title { font-weight: 600; color: var(--color-accent); font-size:1.08rem;}
    .ticket-list { margin-top: 14px; padding-top: 10px; border-top: 1.5px solid #eeeeee;}
    .card { background: var(--color-light); border-radius: 14px; box-shadow: 0 2px 9px #00313514; padding: 19px 16px; border: 2px solid var(--color-aqua); margin-bottom: 13px; display: flex; flex-direction: column; gap: 5px; transition: background 0.35s, color 0.35s;}
    .card h3 { color: var(--color-aqua); font-size: 20px; font-weight: bold; margin-bottom: 9px;}
    .card .ticket-info { font-size: 15px; color: var(--color-accent); font-weight: 505;}
    .card .ticket-info label { color: var(--color-dark); font-weight: bold; margin-right: 6px;}
    .card .card-actions { display: flex; gap: 12px; margin-top: 12px;}
    .btn { padding: 9px 19px; border: none; border-radius: 9px; background: var(--color-aqua); color: #fff; font-weight: bold; font-size: 15px; box-shadow: 0 2px 13px #0faaf470; cursor: pointer; transition: background 0.13s, color 0.15s;}
    .btn:hover { background: var(--color-accent);}
    .inline-comment-box { display:none; margin-top:8px;}
    .comment-history {margin-bottom:12px; font-size:15px;}
    .comment-entry {border-bottom:1px solid #eaeaea;padding-bottom:5px;margin-bottom:4px;}
    .comment-entry b {color:var(--color-dark);}
    .comment-entry .date {color:#888;font-size:85%;}
    .ticket-date { color: var(--color-dark);}
    /* DARK MODE STYLES */
    body.dark-mode {
      background: var(--color-dark) !important;
      color: var(--color-light) !important;
    }
    body.dark-mode .sidebar {
      background: var(--color-medium) !important;
      color: var(--color-light);
      box-shadow: 2px 0 18px var(--color-accent);
    }
    body.dark-mode .sidebar h2 { color: var(--color-aqua); }
    body.dark-mode .sidebar a { color: var(--color-light); background: none;}
    body.dark-mode .sidebar a.active, body.dark-mode .sidebar a:hover { background: var(--color-accent) !important; color: #fff;}
    body.dark-mode .sidebar a#logoutBtn { background: var(--color-aqua) !important; color: #fff;}
    body.dark-mode .content,
    body.dark-mode .user-ticket-card,
    body.dark-mode .card,
    body.dark-mode .ticket-list,
    body.dark-mode .filter-form {
      background: var(--color-medium) !important;
      color: var(--color-light) !important;
    }
    body.dark-mode .filter-form label { color: var(--color-aqua);}
    body.dark-mode .btn,
    body.dark-mode .toggle-mode,
    body.dark-mode .ticket-dropdown-btn {
      background: var(--color-accent);
      color: #fff;
    }
    body.dark-mode .btn:hover,
    body.dark-mode .toggle-mode:hover,
    body.dark-mode .ticket-dropdown-btn:hover {
      background: var(--color-aqua);
      color: #fff;
    }
    body.dark-mode .filter-form input,
    body.dark-mode .filter-form select,
    body.dark-mode textarea {
      background: var(--color-dark) !important;
      color: var(--color-light) !important;
      border: 1.2px solid var(--color-aqua);
    }
    body.dark-mode .recent-ticket-title,
    body.dark-mode .card .ticket-info,
    body.dark-mode .card .ticket-info label,
    body.dark-mode .user-ticket-header .user-title {
      color: var(--color-light);
    }
    body.dark-mode .comment-history,
    body.dark-mode .comment-entry {
      background: var(--color-dark) !important;
      color: var(--color-light) !important;
    }
    body.dark-mode .comment-entry b {
      color: var(--color-aqua);
    }
    body.dark-mode .ticket-date {
      color: var(--color-light);
    }
  </style>
  <script>
    function assignTicket(ticketId, btn) {
      var agentId = prompt("Enter agent ID for assignment:");
      btn.disabled = true;
      fetch('/admin/tickets/assign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticket_id: ticketId, agent_id: agentId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          btn.textContent = 'Assigned';
          btn.disabled = true;
        } else {
          btn.disabled = false;
          alert('Error: ' + data.message);
        }
      });
    }
    function closeTicket(ticketId, btn) {
      btn.disabled = true;
      fetch(`/tickets/${ticketId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Closed' })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          btn.textContent = 'Closed';
          btn.disabled = true;
        } else {
          btn.disabled = false;
          alert('Error closing ticket');
        }
      });
    }
    function toggleCommentBox(ticketId, btn) {
      const box = document.getElementById('commentbox-' + ticketId);
      const isOpen = box && box.style.display === 'block';
      document.querySelectorAll('.inline-comment-box').forEach(e => e.style.display = 'none');
      if (box) {
        box.style.display = isOpen ? 'none' : 'block';
        btn.textContent = isOpen ? 'Comments' : 'Hide Comments';
        if (!isOpen) box.querySelector('textarea').focus();
      }
    }
    function postComment(ticketId) {
      const textarea = document.getElementById('commentarea-' + ticketId);
      const comment = textarea.value.trim();
      if (!comment) { alert('Please enter a comment.'); return; }
      fetch('/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticket_id: ticketId, user_id: window.CURRENT_USER_ID, comment })
      })
      .then(res => res.json())
      .then(data => {
        if (data.comment_id) {
          textarea.value = "";
          alert('Comment added!');
        } else {
          alert('Failed to add comment');
        }
      });
    }
    function toggleTickets(id, btn) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
      if (btn) {
        btn.textContent = el.style.display === 'block' ? "Hide Tickets" : "Show All Tickets";
      }
      if (el.style.display === 'block') { el.scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }
    function applyDarkModeFromStorage() {
      if (localStorage.getItem('adminDarkMode') === 'on') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }
    function toggleDarkMode() {
      const on = !document.body.classList.contains('dark-mode');
      document.body.classList.toggle('dark-mode', on);
      localStorage.setItem('adminDarkMode', on ? 'on' : 'off');
    }
    document.addEventListener('DOMContentLoaded', applyDarkModeFromStorage);
  </script>
</head>
<body>
<div class="page-container">
  <div class="sidebar">
    <div class="profile-image-container">
      <img src="{{ admin.photo_url or '/static/default_user.png' }}" alt="Admin Photo" class="profile-image">
    </div>
    <h2>Admin Panel</h2>
    <hr class="sidebar-hr">
    <a href="{{ url_for('admin_dashboard') }}">🏠 Dashboard</a>
    <a href="{{ url_for('admin_all_tickets') }}" class="active">📋 All Tickets</a>
    <a href="{{ url_for('admin_assign_tickets') }}">⚡ Assign Tickets</a>
    <a href="{{ url_for('admin_reports') }}">📊 Reports</a>
    <a href="{{ url_for('admin_manage_users') }}">👤 Manage Users</a>
    <!-- <a href="{{ url_for('admin_categories') }}">🗂️ Categories</a>
    <a href="{{ url_for('admin_settings') }}">⚙️ Settings</a>
    <a href="{{ url_for('admin_logs') }}">📜 View Logs</a> -->
    <a href="{{ url_for('admin_profile') }}">🙍 Admin Profile</a>
    <!-- <a href="{{ url_for('user_dashboard') }}">Switch to User Portal</a> -->
    <a href="{{ url_for('logout') }}" id="logoutBtn">🚪 Logout</a>
  </div>
  <div class="content">
    <div class="top-bar">
      <form class="filter-form" method="get" action="{{ url_for('admin_all_tickets') }}">
        <label>Status:</label>
        <select name="status">
          <option value="">Any</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
        <label>Priority:</label>
        <select name="priority">
          <option value="">Any</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
        <label>Category:</label>
        <input type="text" name="category" placeholder="Category" />
        <button type="submit" class="btn">Filter</button>
      </form>
      <button class="toggle-mode" onclick="toggleDarkMode()">Toggle Mode</button>
    </div>
    <h1>All Tickets</h1>
    <div class="cards-group">
    {% for item in all_user_data %}
      <div class="user-ticket-card">
        <div class="user-ticket-header">
          <img src="{{ item.user.photo_url or '/static/default_user.png' }}" class="profile-pill" alt="User">
          <div>
            <div class="user-title">{{ item.user.name }}</div>
            <div class="user-email">{{ item.user.email }}</div>
          </div>
          {% if item.tickets|length > 1 %}
          <button class="ticket-dropdown-btn" onclick="toggleTickets('tickets-{{ item.user.id }}', this)">
            Show All Tickets
          </button>
          {% endif %}
        </div>
        <div class="ticket-list">
          {% if item.tickets %}
            <div class="recent-ticket-title">Most Recent Ticket:</div>
            <div class="card">
              <h3>
                Ticket #{{ item.tickets[0].id }}
                <span class="ticket-date">({{ item.tickets[0].created_at.strftime('%d-%b-%Y %H:%M') }})</span>
              </h3>
              <div class="ticket-info"><label>Category:</label> {{ item.tickets[0].category }}</div>
              <div class="ticket-info"><label>Priority:</label>
                <span style="color: {{ 'red' if item.tickets[0].priority == 'High' else 'inherit' }};">{{ item.tickets[0].priority }}</span>
              </div>
              <div class="ticket-info"><label>Status:</label> {{ item.tickets[0].status }}</div>
              <div class="ticket-info"><label>Assigned To:</label> {{ item.tickets[0].assigned_to or 'Unassigned' }}</div>
              <div class="ticket-info"><label>Description:</label> {{ item.tickets[0].description }}</div>
              <div class="card-actions">
                <button class="btn"
                  onclick="assignTicket({{ item.tickets[0].id }}, this)"
                  {% if item.tickets[0].assigned_to %}disabled{% endif %}>
                  {% if item.tickets[0].assigned_to %}Assigned{% else %}Assign{% endif %}
                </button>
                <button class="btn"
                  onclick="closeTicket({{ item.tickets[0].id }}, this)"
                  {% if item.tickets[0].status == "Closed" %}disabled{% endif %}>
                  {% if item.tickets[0].status == "Closed" %}Closed{% else %}Close{% endif %}
                </button>
                <button class="btn"
                  onclick="toggleCommentBox({{ item.tickets[0].id }}, this)">
                  Comments
                </button>
              </div>
              <div class="inline-comment-box" id="commentbox-{{ item.tickets[0].id }}" style="display:none; margin-top:8px;">
                {% if comments_map[item.tickets[0].id] %}
                <div class="comment-history">
                  {% for c in comments_map[item.tickets[0].id] %}
                    <div class="comment-entry">
                      <b>{{ user_map[c.user_id] }}</b>
                      <span class="date">({{ c.created_at.strftime('%d-%b-%Y %H:%M') }})</span>:<br>
                      <span>{{ c.comment }}</span>
                    </div>
                  {% endfor %}
                </div>
                {% endif %}
                <textarea id="commentarea-{{ item.tickets[0].id }}" rows="2" placeholder="Write a comment..." style="width:88%;padding:7px;border-radius:7px;"></textarea>
                <button class="btn" style="margin-left:8px;" onclick="postComment({{ item.tickets[0].id }})">Submit</button>
              </div>
            </div>
          {% else %}
            <div style="color:#888;margin-top:10px;"><i>No tickets from this user.</i></div>
          {% endif %}
          {% if item.tickets|length > 1 %}
          <div id="tickets-{{ item.user.id }}" class="tickets-dropdown" style="display:none;">
            <hr>
            <span style="font-weight:600;">Other Tickets:</span>
            <div class="cards">
              {% for t in item.tickets[1:] %}
                <div class="card">
                  <h3>
                    Ticket #{{ t.id }}
                    <span class="ticket-date">({{ t.created_at.strftime('%d-%b-%Y %H:%M') }})</span>
                  </h3>
                  <div class="ticket-info"><label>Category:</label> {{ t.category }}</div>
                  <div class="ticket-info"><label>Priority:</label>
                    <span style="color: {{ 'red' if t.priority == 'High' else 'inherit' }};">{{ t.priority }}</span>
                  </div>
                  <div class="ticket-info"><label>Status:</label> {{ t.status }}</div>
                  <div class="ticket-info"><label>Assigned To:</label> {{ t.assigned_to or 'Unassigned' }}</div>
                  <div class="ticket-info"><label>Description:</label> {{ t.description }}</div>
                  <div class="card-actions">
                    <button class="btn"
                      onclick="assignTicket({{ t.id }}, this)"
                      {% if t.assigned_to %}disabled{% endif %}>
                      {% if t.assigned_to %}Assigned{% else %}Assign{% endif %}
                    </button>
                    <button class="btn"
                      onclick="closeTicket({{ t.id }}, this)"
                      {% if t.status == "Closed" %}disabled{% endif %}>
                      {% if t.status == "Closed" %}Closed{% else %}Close{% endif %}
                    </button>
                    <button class="btn"
                      onclick="toggleCommentBox({{ t.id }}, this)">
                      Comments
                    </button>
                  </div>
                  <div class="inline-comment-box" id="commentbox-{{ t.id }}" style="display:none; margin-top:8px;">
                    {% if comments_map[t.id] %}
                    <div class="comment-history">
                      {% for c in comments_map[t.id] %}
                        <div class="comment-entry">
                          <b>{{ user_map[c.user_id] }}</b>
                          <span class="date">({{ c.created_at.strftime('%d-%b-%Y %H:%M') }})</span>:<br>
                          <span>{{ c.comment }}</span>
                        </div>
                      {% endfor %}
                    </div>
                    {% endif %}
                    <textarea id="commentarea-{{ t.id }}" rows="2" placeholder="Write a comment..." style="width:88%;padding:7px;border-radius:7px;"></textarea>
                    <button class="btn" style="margin-left:8px;" onclick="postComment({{ t.id }})">Submit</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
    </div>
  </div>
</div>
<script>
  window.CURRENT_USER_ID = {{ admin.id }};
</script>
</body>
</html>

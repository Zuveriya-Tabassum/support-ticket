<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --color-dark: #003135;
      --color-medium: #024950;
      --color-accent: #964734;
      --color-aqua: #0FAAAF;
      --color-light: #AFDDE5;
      --sidebar-width: 240px;
      --font-main: 'Poppins', 'Segoe UI', Arial, sans-serif;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: var(--font-main);
      background: var(--color-light);
      color: var(--color-dark);
      transition: background 0.35s, color 0.35s;
    }
    .toggle-mode {
      position: absolute;
      top: 25px;
      right: 42px;
      z-index: 100;
      background: var(--color-aqua);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 10px 23px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 12px #0faaf490;
      transition: background 0.13s;
    }
    .toggle-mode:hover {
      background: var(--color-accent);
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-dark);
      color: var(--color-light);
      height: 100vh;
      padding: 28px 17px 28px 17px;
      display: flex; flex-direction: column;
      position: fixed;
      left: 0; top: 0;
      box-shadow: 2px 0 18px #02495080;
      z-index: 10;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .sidebar::-webkit-scrollbar { width: 0 !important; display: none; }
    .profile-image-container {
      width: 120px; height: 120px;
      margin: 0 auto 17px auto;
      display: flex; align-items: center; justify-content: center;
    }
    .profile-image {
      width: 100px; height: 100px; object-fit: cover;
      border-radius: 50%; border: 4px solid var(--color-aqua);
      background: #fff; box-shadow: 0 2px 14px #00313540;
    }
    .sidebar h2 {
      margin-bottom: 22px;
      font-size: 24px;
      color: var(--color-aqua);
      font-weight: 700;
      text-align: center; letter-spacing: 2px;
    }
    .sidebar-hr {
      border: none; height: 2px;
      background: linear-gradient(90deg, #0FAAAF33 30%, #00313544 100%);
      margin: 1.5px 0 20px 0; width: 82%; align-self: center;
    }
    .sidebar a {
      text-decoration: none; color: var(--color-light);
      margin: 10.5px 0; font-size: 17px; padding: 12px 10px;
      border-radius: 8px; font-weight: 500;
      display: flex; align-items: center; transition: background 0.19s, color 0.17s;
    }
    .sidebar a.active, .sidebar a:hover {
      background: var(--color-aqua); color: #fff; font-weight: bold;
      box-shadow: 0 2px 12px #0faaf462;
    }
    .sidebar a#logoutBtn {
      background: var(--color-accent); color: #fff;
      margin-top: 2rem; font-weight: bold;
    }
    .content {
      margin-left: calc(var(--sidebar-width) + 32px);
      padding: 54px 26px;
      min-height: 100vh;
      color: var(--color-dark); 
      background: none; 
      transition: background 0.3s, color 0.3s;
      overflow-y: auto;
      scrollbar-width: none;
    }
    .content::-webkit-scrollbar { width: 0 !important; display: none; }
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 32px 0 14px 0;
    }
    .filter-label {
      color: var(--color-medium);
      font-weight: bold;
      font-size: 1em;
    }
    .filter-select {
      font-family: inherit;
      font-size: 1em;
      padding: 8px 22px;
      border-radius: 8px;
      border: 1.5px solid var(--color-aqua);
      color: var(--color-dark);
      background: var(--color-light);
      font-weight: 500;
      transition: border 0.13s;
    }
    .filter-select:focus { border: 2px solid var(--color-accent); outline: none; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #00313526;
      overflow: hidden;
      transition: background 0.33s, color 0.33s;
    }
    th, td {
      padding: 14px 14px;
      text-align: left;
      border-bottom: 1px solid #aae2e088;
      transition: color 0.33s, background 0.33s;
    }
    th {
      background: var(--color-light);
      color: var(--color-dark);
      font-weight: bold;
    }
    tr:last-child td { border-bottom: none; }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 7px;
      background: var(--color-aqua); color: #fff;
      cursor: pointer;
      font-weight: bold;
      margin-right: 7px;
      transition: background 0.18s, opacity 0.15s;
      position: relative;
    }
    .btn.deactivated {
      background: #888;
      color: #fff;
    }
    .btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      border: 2px solid transparent;
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .btn:hover:not(.deactivated):not(.loading) { background: var(--color-accent);}
    .role-admin { color: var(--color-accent);}
    .role-user { color: var(--color-dark);}
    .status-active {
      color: var(--color-aqua) !important;
      font-weight: 600;
    }
    .status-inactive {
      color: #B94A48 !important;
      font-weight: 600;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .toast.success { background: var(--color-aqua); }
    .toast.error { background: var(--color-accent); }
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* DARK MODE STYLES */
    body.dark-mode {
      background: var(--color-dark) !important;
      color: var(--color-light) !important;
    }
    body.dark-mode .sidebar {
      background: var(--color-medium) !important;
      color: var(--color-light);
      box-shadow: 2px 0 18px var(--color-accent);
    }
    body.dark-mode .sidebar h2 {
      color: var(--color-aqua);
    }
    body.dark-mode .sidebar a {
      color: var(--color-light);
      background: none;
    }
    body.dark-mode .sidebar a.active, body.dark-mode .sidebar a:hover {
      background: var(--color-accent) !important;
      color: #fff;
    }
    body.dark-mode .sidebar a#logoutBtn {
      background: var(--color-aqua) !important;
      color: #fff;
    }
    body.dark-mode .content {
      background: none;
      color: var(--color-light);
    }
    body.dark-mode table {
      background: var(--color-medium);
      color: var(--color-light);
    }
    body.dark-mode th, body.dark-mode td {
      color: var(--color-light);
      border-bottom: 1px solid #0FAAAF44;
    }
    body.dark-mode .btn, body.dark-mode .toggle-mode {
      background: var(--color-accent) !important;
      color: #fff !important;
    }
    body.dark-mode .btn:hover, body.dark-mode .toggle-mode:hover {
      background: var(--color-aqua) !important;
      color: #fff !important;
    }
    /* Responsive */
    @media(max-width: 1000px) {
      .content {
        margin-left: 0 !important; padding: 22px 5px;
      }
      .sidebar {
        position: relative; width: 100vw; height: auto;
        flex-direction: row; box-shadow: none; padding: 0 0 0 20px;
        justify-content: flex-start; overflow-y: visible;
      }
      .profile-image-container { width: 62px; height: 62px; margin: 0 10px 0 0; }
      .profile-image { width: 45px; height: 45px; border-width: 2px; }
      .sidebar h2 { font-size: 17px; margin-bottom: 0; padding: 0 0 0 10px; }
      .sidebar a { font-size: 15px; padding: 8px 7px; margin: 0 12px 0 0; border-radius: 8px; }
    }
    @media(max-width: 600px) {
      .profile-image-container { width: 36px; height: 36px; }
      .profile-image { width: 28px; height: 28px; border-width: 2px; }
    }
  </style>
</head>
<body>
  <!-- Toggle button for Dark Mode -->
  <button class="toggle-mode" onclick="toggleDarkMode()">Toggle Mode</button>
  <div class="sidebar">
    <div class="profile-image-container">
      <img src="{{ admin.photo_url or '/static/default_user.png' }}" alt="Admin Photo" class="profile-image">
    </div>
    <h2>Admin Panel</h2>
    <hr class="sidebar-hr">
    <a href="{{ url_for('admin_dashboard') }}" class="{% if pagename=='dashboard' %}active{% endif %}">üè† Dashboard</a>
    <a href="{{ url_for('admin_all_tickets') }}" class="{% if pagename=='tickets' %}active{% endif %}">üìã All Tickets</a>
    <a href="{{ url_for('admin_assign_tickets') }}" class="{% if pagename=='assign' %}active{% endif %}">‚ö° Assign Tickets</a>
    <a href="{{ url_for('admin_reports') }}" class="{% if pagename=='reports' %}active{% endif %}">üìä Reports</a>
    <a href="{{ url_for('admin_manage_users') }}" class="{% if pagename=='users' %}active{% endif %}">üë§ Manage Users</a>
    <!-- <a href="{{ url_for('admin_categories') }}" class="{% if pagename=='categories' %}active{% endif %}">üóÇÔ∏è Categories</a>
    <a href="{{ url_for('admin_settings') }}" class="{% if pagename=='settings' %}active{% endif %}">‚öôÔ∏è Settings</a>
    <a href="{{ url_for('admin_logs') }}" class="{% if pagename=='logs' %}active{% endif %}">üìú View Logs</a> -->
    <a href="{{ url_for('admin_profile') }}" class="{% if pagename=='profile' %}active{% endif %}">üôç Admin Profile</a>
    <!-- <a href="{{ url_for('user_dashboard') }}">Switch to User Portal</a> -->
    <a href="{{ url_for('logout') }}" id="logoutBtn">üö™ Logout</a>
  </div>
  <div class="content">
    <h1>Manage Users</h1>
    <div class="filter-bar">
      <span class="filter-label">Filter by Role:</span>
      <select id="roleFilter" class="filter-select" onchange="filterUsers()">
        <option value="">All</option>
        <option value="admin">Admin</option>
        <option value="user">User</option>
      </select>
      <span class="filter-label" style="margin-left: 20px;">Filter by Status:</span>
      <select id="statusFilter" class="filter-select" onchange="filterUsers()">
        <option value="">All</option>
        <option value="active">Active</option>
        <option value="inactive">On Hold</option>
      </select>
    </div>
    <table id="usersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Last Login</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr data-role="{{ user.role }}" data-uid="{{ user.id }}" data-status="{{ 'active' if user.active else 'inactive' }}">
          <td>{{ user.id }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td class="role-{{ user.role }}">{{ user.role|capitalize }}</td>
          <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else "Never" }}</td>
          <td class="status-cell">
            {% if user.active %}
              <span class="status-active">Active</span>
            {% else %}
              <span class="status-inactive">On Hold</span>
            {% endif %}
          </td>
          <td>
            <button class="btn" onclick="editUser({{ user.id }})">Edit</button>
            {% if user.active %}
              <button class="btn" onclick="confirmToggle({{ user.id }}, this, 'deactivate')">Deactivate</button>
            {% else %}
              <button class="btn deactivated" onclick="confirmToggle({{ user.id }}, this, 'activate')">Activate</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    function applyDarkModeFromStorage() {
      if (localStorage.getItem('adminDarkMode') === 'on') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }
    function toggleDarkMode() {
      const on = !document.body.classList.contains('dark-mode');
      document.body.classList.toggle('dark-mode', on);
      localStorage.setItem('adminDarkMode', on ? 'on' : 'off');
    }
    document.addEventListener('DOMContentLoaded', applyDarkModeFromStorage);
    document.addEventListener('visibilitychange', applyDarkModeFromStorage);

    function filterUsers() {
      var roleSelected = document.getElementById('roleFilter').value;
      var statusSelected = document.getElementById('statusFilter').value;
      var rows = document.querySelectorAll('#usersTable tbody tr');
      rows.forEach(function(row){
        var roleMatch = !roleSelected || row.getAttribute('data-role') === roleSelected;
        var statusMatch = !statusSelected || row.getAttribute('data-status') === statusSelected;
        if(roleMatch && statusMatch) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    function showToast(message, type = 'success') {
      var existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      var toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function confirmToggle(userId, btn, action) {
      var actionText = action === 'activate' ? 'activate' : 'deactivate';
      var confirmation = confirm(`Are you sure you want to ${actionText} this user?`);
      if (confirmation) {
        toggleStatus(userId, btn, action);
      }
    }
    function toggleStatus(userId, btn, action) {
      btn.classList.add('loading');
      var originalText = btn.textContent;
      btn.textContent = '';
      fetch(`/admin/toggle_user_status/${userId}`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          var row = btn.closest('tr');
          var statusCell = row.querySelector('.status-cell');
          if(data.active) {
            btn.textContent = "Deactivate";
            btn.classList.remove('deactivated');
            statusCell.innerHTML = '<span class="status-active">Active</span>';
            row.setAttribute('data-status', 'active');
            showToast('User activated successfully!', 'success');
          } else {
            btn.textContent = "Activate";
            btn.classList.add('deactivated');
            statusCell.innerHTML = '<span class="status-inactive">On Hold</span>';
            row.setAttribute('data-status', 'inactive');
            showToast('User deactivated successfully!', 'success');
          }
        } else {
          throw new Error(data.message || 'Unknown error occurred');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        btn.textContent = originalText;
        showToast(`Error: ${error.message}`, 'error');
      })
      .finally(() => {
        btn.classList.remove('loading');
        btn.blur();
      });
    }
    function editUser(userId) {
      window.location.href = `/admin/users/${userId}/edit`;
    }
  </script>
</body>
</html>
